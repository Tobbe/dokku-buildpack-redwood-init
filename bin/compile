#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}

echo "------> Initializing"

# Copy files to app unless they already exist
[ ! -d $1/config ] && mkdir $1/config
[ ! -s $1/config/nginx.conf.erb ] && cp config/nginx.conf.erb $1/config/nginx.conf.erb
[ ! -s $1/app.json ] && cp app.json $1/app.json
[ ! -s $1/index.js ] && cp index.js $1/index.js
[ ! -s $1/Procfile ] && cp Procfile $1/Procfile

apiVersion=$(jq '.dependencies["@redwoodjs/api"]' $1/api/package.json)
echo "        Add api-server $apiVersion to api/package.json"

jq ".dependencies[\"@redwoodjs/api-server\"] = $apiVersion" $1/api/package.json > $1/api/_package.json
mv $1/api/_package.json $1/api/package.json

coreVersion=$(jq '.devDependencies["@redwoodjs/core"]' $1/package.json)
[ $coreVersion = "null" ] && coreVersion=$(jq '.dependencies["@redwoodjs/core"]' $1/package.json)

echo "        Move core $coreVersion to regular dependency"

cat $1/package.json | \
  jq 'del(.devDependencies["@redwoodjs/core"])' | \
  jq ".dependencies[\"@redwoodjs/core\"] = $coreVersion" | \
  jq '.dependencies.pm2 = "^4.5.5"' > $1/_package.json
mv $1/_package.json $1/package.json
